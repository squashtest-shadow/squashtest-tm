<?xml version="1.0" encoding="UTF-8"?>
<!--

        This file is part of the Squashtest platform.
        Copyright (C) 2010 - 2013 Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<!-- DO NOT FORGET TO UPDATE VERSION IN CORE_CONFIG ! -->
	<changeSet id="tm-1.6.0" author="mpagnon">
		<comment>Update TM database version number</comment>
		<update tableName="CORE_CONFIG">
			<column name="VALUE" value="1.6.0" />
			<where>STR_KEY = 'squashtest.tm.database.version'</where>
		</update>
	</changeSet>

	<changeSet id="tm-1.6.0.feat-1101-01" author="mpagnon">
		<comment>Add table to handle test cases PARAMETERS</comment>
		<createTable tableName="PARAMETER">
			<column name="PARAM_ID" type="BIGINT" autoIncrement="true"
				remarks="the PARAMETER primary key">
				<constraints primaryKey="true" nullable="false"
					primaryKeyName="pk_parameter" />
			</column>
			<column name="NAME" type="VARCHAR(255)" defaultValue=""
				remarks="the parameter name, should be unique among parameters of the same test case">
				<constraints nullable="false" />
			</column>
			<column name="TEST_CASE_ID" type="BIGINT"
				remarks="the test case where the parameter is declared">
				<constraints nullable="false" foreignKeyName="fk_parameter_test_case"
					references="TEST_CASE(TCLN_ID)" />
			</column>
			<column name="DESCRIPTION" type="CLOB" defaultValue=""
				remarks="the description of the parameter">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint tableName="PARAMETER"
			columnNames="NAME,TEST_CASE_ID" />
	</changeSet>

	<changeSet id="tm-1.6.0.feat-1101-02" author="mpagnon">
		<comment>Add tables to handle test cases DATASETS</comment>
		<createTable tableName="DATASET">
			<column name="DATASET_ID" type="BIGINT" autoIncrement="true"
				remarks="the DATASET primary key">
				<constraints primaryKey="true" nullable="false"
					primaryKeyName="pk_dataset" />
			</column>
			<column name="NAME" type="VARCHAR(255)" defaultValue=""
				remarks="the dataset name, should be unique among parameters of the same test case">
				<constraints nullable="false" />
			</column>
			<column name="TEST_CASE_ID" type="BIGINT"
				remarks="the test case where the parameter is declared">
				<constraints nullable="false" foreignKeyName="fk_dataset_test_case"
					references="TEST_CASE(TCLN_ID)" />
			</column>
		</createTable>
		<addUniqueConstraint tableName="DATASET"
			columnNames="NAME,TEST_CASE_ID" />
		<createTable tableName="DATASET_PARAM_VALUE">
			<column name="DATASET_PARAM_VALUE_ID" type="BIGINT"
				autoIncrement="true" remarks="the DATASET_PARAM_VALUE primary key">
				<constraints primaryKey="true" nullable="false"
					primaryKeyName="pk_dataset_param_value" />
			</column>
			<column name="DATASET_ID" type="BIGINT"
				remarks="the dataset holding the value for the parameter">
				<constraints nullable="false" foreignKeyName="fk_dataset_param_value_dataset"
					references="DATASET(DATASET_ID)" />
			</column>
			<column name="PARAM_ID" type="BIGINT"
				remarks="the parameter to set the value of">
				<constraints nullable="false" foreignKeyName="fk_dataset_param_value_param"
					references="PARAMETER(PARAM_ID)" />
			</column>
			<column name="PARAM_VALUE" type="VARCHAR(255)" defaultValue=""
				remarks="the value for the parameter in the dataset">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint tableName="DATASET_PARAM_VALUE"
			columnNames="DATASET_ID,PARAM_ID" />
	</changeSet>
	<changeSet id="tm-1.6.0.feat-1128-01" author="mpagnon">
		<comment>Add column to bind a test plan item to a DATASET</comment>
		<addColumn tableName="ITERATION_TEST_PLAN_ITEM">
			<column name="DATASET_ID" type="BIGINT"
				remarks="the dataset the test plan item should use to replace the parameters in new execution steps">
				<constraints nullable="true"
					foreignKeyName="fk_iteration_test_plan_item_dataset" references="DATASET(DATASET_ID)" />
			</column>
		</addColumn>
	</changeSet>
</databaseChangeLog>
 