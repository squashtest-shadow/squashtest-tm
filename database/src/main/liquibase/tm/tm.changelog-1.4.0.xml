<?xml version="1.0" encoding="UTF-8"?>
<!--

        This file is part of the Squashtest platform.
        Copyright (C) 2010 - 2012 Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <!-- DO NOT FORGET TO UPDATE VERSION IN CORE_CONFIG ! -->
    <changeSet id="tm-1.4.0.00" author="gfouquet">
        <comment>Adds a TM database version number</comment>
        <update tableName="CORE_CONFIG">
            <column name="STR_KEY" value="squashtest.tm.database.version" />
            <column name="VALUE" value="1.1.0" />
            <where>STR_KEY = 'squashtest.tm.database.version'</where>
        </update>
    </changeSet>

    <changeSet author="gfouquet" id="tm-1.4.0-feat-1109.01">
        <comment>Creates a table for Custom Fields</comment>
        <createTable tableName="CUSTOM_FIELD">
            <column name="CF_ID" type="BIGINT"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_custom_field"/>
            </column>

            <column name="FIELD_TYPE" type="CHAR(3)">
                   <constraints nullable="false" />
            </column>

            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>

            <column name="LABEL" type="VARCHAR(255)" defaultValue="">
                <constraints nullable="false" />
            </column>

            <column name="OPTIONAL" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false" />
            </column>

            <column name="DEFAULT_VALUE" type="VARCHAR(255)">
                <constraints nullable="true" />
            </column>

            <column name="INPUT_TYPE" type="CHAR(30)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet author="gfouquet" id="tm-1.4.0-feat-1109.02">
        <comment>Creates a table for Custom Fields Options</comment>
        <createTable tableName="CUSTOM_FIELD_OPTION">
            <column name="CF_ID" type="BIGINT">
                <constraints nullable="false" references="CUSTOM_FIELD(CF_ID)" foreignKeyName="fk_cf_option_cf"/>
            </column>

            <column name="LABEL" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>

            <column name="POSITION" type="INT">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet author="gfouquet" id="tm-1.4.0-feat-1390.01">
        <comment>Creates a table for Custom Fields Binding</comment>
        <createTable tableName="CUSTOM_FIELD_BINDING">
            <column name="CFB_ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_cfb_option" />
            </column>

            <column name="CF_ID" type="BIGINT">
                <constraints nullable="false" references="CUSTOM_FIELD(CF_ID)" foreignKeyName="fk_cfb_cf"/>
            </column>

            <column name="BOUND_ENTITY" type="VARCHAR(30)">
                <constraints nullable="false" />
            </column>

            <column name="BOUND_PROJECT_ID" type="BIGINT">
                <constraints nullable="false"  references="PROJECT(PROJECT_ID)" foreignKeyName="fk_cfb_bound_project"/>
            </column>

            <column name="POSITION" type="INT">
                <constraints nullable="true" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="CUSTOM_FIELD_BINDING" columnNames="BOUND_PROJECT_ID, BOUND_ENTITY, CF_ID" constraintName="uc_cf_entity_proj_bnd" />
    </changeSet>

    <changeSet author="gfouquet" id="tm-1.4.0-feat-1390.02">
        <comment>Creates a table for rendering locations of a bound custom field</comment>
        <createTable tableName="CUSTOM_FIELD_RENDERING_LOCATION">
            <column name="CFB_ID" type="BIGINT">
                <constraints nullable="false" references="CUSTOM_FIELD_BINDING(CFB_ID)" foreignKeyName="fk_cfb_render_loc_cfb"/>
            </column>

            <column name="RENDERING_LOCATION" type="VARCHAR(30)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>