<?xml version="1.0" encoding="UTF-8"?>
<!--

        This file is part of the Squashtest platform.
        Copyright (C) 2010 - 2012 Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <!-- DO NOT FORGET TO UPDATE VERSION IN CORE_CONFIG ! -->
    <changeSet id="tm-1.5.0.00" author="mpagnon">
        <comment>Update TM database version number</comment>
        <update tableName="CORE_CONFIG">
            <column name="STR_KEY" value="squashtest.tm.database.version" />
            <column name="VALUE" value="1.5.0" />
            <where>STR_KEY = 'squashtest.tm.database.version'</where>
        </update>
    </changeSet>
    
     <changeSet id="tm-1.5.0.feat-1596.02" author="bsiri">
    	<comment>dropping the temp table from changest tm-1.4.0.feat-1596.01</comment>
    	<dropTable tableName="EXECUTION_TEST_CASE_DATA"/>    
    </changeSet>
   
    
    
  	<changeSet id="tm-1.5.0.00-issue-1838.01" author="mpagnon">
  		<comment>Update table custom-field-value so that all mandatory cuf have a value</comment>
  		<sql>
  			update CUSTOM_FIELD_VALUE
  			set VALUE = (
  				select cf.DEFAULT_VALUE 
  				from CUSTOM_FIELD_BINDING cfb 
  					join CUSTOM_FIELD cf on cfb.CF_ID = cf.CF_ID 
  				where cfb.CFB_ID = CUSTOM_FIELD_VALUE.CFB_ID
  				)
  			where (CUSTOM_FIELD_VALUE.VALUE is null or LTRIM(RTRIM(CUSTOM_FIELD_VALUE.VALUE)) = '' )
  			and exists (
  				select * 
  				from CUSTOM_FIELD_BINDING cfb 
  					join CUSTOM_FIELD cf on cfb.CF_ID = cf.CF_ID 
  				where cfb.CFB_ID = CUSTOM_FIELD_VALUE.CFB_ID 
  				and cf.OPTIONAL = false)
  			;
  		</sql>
  	</changeSet>
  	
  	<changeSet id="tm-1.5.0.00-feat-1390.03" author="bsiri">
  		<comment>adding cascade delete on the rendering locations when custom field bindings are removed (prune the orphans)</comment>
  		
  		<dropForeignKeyConstraint baseTableName="CUSTOM_FIELD_RENDERING_LOCATION" constraintName="fk_cfb_render_loc_cfb"/>
  		
  		<addForeignKeyConstraint constraintName="fk_cfb_render_loc_cfb" onDelete="CASCADE"
  								 referencedTableName="CUSTOM_FIELD_BINDING"  referencedColumnNames="CFB_ID"
  								baseTableName="CUSTOM_FIELD_RENDERING_LOCATION" baseColumnNames="CFB_ID"  />
  		
  	</changeSet>
</databaseChangeLog>
 