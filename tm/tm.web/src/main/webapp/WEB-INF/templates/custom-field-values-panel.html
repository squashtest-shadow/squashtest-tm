<!--

        This file is part of the Squashtest platform.
        Copyright (C) 2010 - 2014 Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<div th:remove="all">
	<!--  documentation : 
			Parameters :
				- a CustomFieldValueConfigurationBean, named 'configuration'
				- a boolean named 'editable' saying whether those values are editable. 
	 -->

</div>


<div th:remove="all">
	<script type="text/javascript">
		var require = {
			baseUrl : '../../scripts/'
		};
	</script>
	<script type="text/javascript"
		src="../../scripts/lib/jquery/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="../../js/thymol.js"></script>
	<script type="text/javascript" src="../../scripts/require.js"></script>
	<script type="text/javascript" src="../../scripts/common.js"></script>

	<link rel="stylesheet" type="text/css" media="all"
		href="../../../../../../../tm/tm.web/src/main/webapp/styles/squash.core.css"
		sq:css="squash.core.css" />
	<link rel="shortcut icon" type="image/x-icon" media="all"
		href="../../../../../../../tm/tm.web/src/main/webapp/images/favicon.ico"
		th:href="@{/images/favicon.ico}" />
	<link rel="stylesheet" type="text/css" media="all"
		href="../../../../../../../tm/tm.web/src/main/webapp/styles/squash.grey.css"
		sq:css="squash.grey.css" />

</div>

<div class="display-table-row"
	th:each="confBean : ${configuration.configurationBeans}">
	<label class="display-table-cell" th:text="${confBean.fieldLabel}"
		th:for="'cuf-value-'+${confBeanStat.count}">quantité de café</label>
	<div class="display-table-cell" th:switch="${confBean.type}">
		<input th:case="'checkbox'" type="checkbox" th:disabled="${!editable}"
			th:checked="${confBean.valueAsBoolean}"
			th:id="'cuf-value-'+${confBeanStat.count}" class="cuf-value-control" />
		<span th:case="'datepicker'"
			th:id="'cuf-value-'+${confBeanStat.count}" class="cuf-value-control"
			th:text="${confBean.valueAsDate}? ${#dates.format(confBean.valueAsDate,'__#{squashtm.dateformatShort}__')} : #{squashtm.nodata}">
			01-02-2012</span> 
        <div th:case="'ckeditor'" 
            th:id="'cuf-value-'+${confBeanStat.count}" class="cuf-value-control"
            th:utext="${confBean.fieldValue}"> <p>rich text</p></div>
		<span th:case="*"
			th:id="'cuf-value-'+${confBeanStat.count}" class="cuf-value-control"
			th:text="${confBean.fieldValue}">maximum</span>
	</div>
</div>

<script id="cuf-value-init" th:if="${editable}" type="text/javascript"
	th:inline="javascript">
	//<![CDATA[
	require(
			[ 'domReady', 'jquery', 'squash.configmanager', 'app/ws/squashtm.notification',
			  'jquery.squash.jeditable', "jeditable.datepicker",
				"datepicker/jquery.squash.datepicker-locales" ],
			function(domReady, $, confman, notification) {

				var imgUrl = /*[[@{/scripts/jquery/indicator.gif}]]*/"../../scripts/jquery/indicator.gif";
				var fieldMandatoryMessage = /*[[#{message.cuf.value.mandatory}]]*/'The custom field is mandatory';
				var errorTitle = /*[[ #{popup.title.error} ]]*/'Erreur';
				var cufValuesUrl = /*[[@{/custom-fields/values}+'/']]*/"http://localhost:8080/squash/custom-fields/values/";
				var locale = /*[[ #{squashtm.locale} ]]*/"fr";
				var localizedDateFormat = /*[[ #{squashtm.dateformatShort.datepicker} ]]*/"dd/mm/yy"
				var noDateString = /*[[ #{squashtm.nodata} ]]*/"-";
				
				var baseConf = confman.getStdJeditable();

				var postFunction = function(value, settings) {
					if (!settings.optional && $.trim(value) === "") {
						notification.showError(fieldMandatoryMessage);
						return this.revert;
					}
					var url = cufValuesUrl + settings.fieldId;
					$.post(url, {
						value : value
					});
					return value;
				};
				
				/**************** code for CkEditor   ***************/
				
				var ckeBaseConf = confman.getJeditableCkeditor();
				
				/**************** code for CkEditor   ***************/

				/**************** code for DatePicker ***************/
				
				//DatePickerBaseConf
				var datePickBaseConf = $.extend({
					datepicker : confman.getStdDatepicker()
				}, baseConf);

				//Post Function
				var datePickerPostFunction = function(value, settings) {
					var localizedDate = value;
					var postDateFormat = $.datepicker.ATOM;
					var date = $.datepicker
							.parseDate(localizedDateFormat,	localizedDate);
					var postDate = $.datepicker
							.formatDate(postDateFormat, date);
					var returned = postFunction.call(this, postDate, settings)
					if (returned === "") {
						return noDateString;
					} else {
						return value;
					}

				};
				/**************** end code for DatePicker ***************/

				var settings = /*[[${configuration.configurationBeans}]]*/[];

				domReady(function() {

					var widgets = $("input.cuf-value-control").add(
							"span.cuf-value-control");
					widgets.parent('div').addClass("editable");

					var count = widgets.length;
					for ( var i = 0; i < count; i++) {
						var widget = widgets.eq(i);
						var conf = settings[i];
						console.log(conf.type);
						//non-jeditable inputs
						if (conf.type === 'checkbox') {
							var checkbox_conf = conf;
							widget.change(function() {
								postFunction(this.checked, checkbox_conf);
							});
						}
						//jeditable inputs
						else if (conf.type === 'datepicker') {
							var effective = $.extend({}, datePickBaseConf, conf);
							widget.editable(datePickerPostFunction, effective);
						} 
						else if (conf.type === 'ckeditor'){
							var effective = $.extend({}, ckeBaseConf, conf);
							widget.editable(postFunction, effective);
						}
						else {
							var effective = $.extend({}, baseConf, conf);
							widget.editable(postFunction, effective);
						}
					}
				});
			});
	//]]>
</script>

